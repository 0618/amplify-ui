{"version":3,"file":"auth.decorator.js","sourceRoot":"","sources":["../../../src/providers/auth.decorator.ts"],"names":[],"mappings":"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","sourcesContent":["import { Subject } from 'rxjs';\nimport { Amplify, Logger, Hub } from '@aws-amplify/core';\nimport { AuthState } from './auth.state';\nimport * as _ from 'lodash';\n\nconst logger = new Logger('AuthDecorator');\n\nfunction check(authState: Subject<AuthState>, Auth) {\n  // check for current authenticated user to init authState\n  Auth.currentAuthenticatedUser()\n    .then((user) => {\n      logger.debug('has authenticated user', user);\n      authState.next({ state: 'signedIn', user });\n    })\n    .catch((err) => {\n      logger.debug('no authenticated user', err);\n      authState.next({ state: 'signedOut', user: null });\n    });\n}\n\nfunction listen(authState: Subject<AuthState>) {\n  const config = Amplify.configure(null);\n  if (_.has(config, 'Auth.oauth')) {\n    Hub.listen(\n      'auth',\n      {\n        onHubCapsule: (capsule) => {\n          const { channel, payload } = capsule;\n          if (channel === 'auth') {\n            const { username } = payload.data;\n            logger.debug('authentication oauth event', payload);\n            authState.next({ state: payload.event, user: { username } });\n          }\n        },\n      },\n      'angularAuthListener'\n    );\n  }\n}\n\nfunction decorateSignIn(authState: Subject<AuthState>, Auth) {\n  const _signIn = Auth.signIn;\n  Auth.signIn = (username: string, password: string): Promise<any> => {\n    return _signIn\n      .call(Auth, username, password)\n      .then((user) => {\n        logger.debug('signIn success');\n        if (!user.challengeName) {\n          authState.next({ state: 'signedIn', user });\n          return user;\n        }\n\n        logger.debug('signIn challenge: ' + user.challengeName);\n        if (user.challengeName === 'NEW_PASSWORD_REQUIRED') {\n          authState.next({ state: 'requireNewPassword', user });\n        } else if (user.challengeName === 'MFA_SETUP') {\n          authState.next({ state: 'setupMFA', user });\n        } else if (\n          user.challengeName === 'SMS_MFA' ||\n          user.challengeName === 'SOFTWARE_TOKEN_MFA'\n        ) {\n          authState.next({ state: 'confirmSignIn', user });\n        } else {\n          logger.debug(\n            'warning: unhandled challengeName ' + user.challengeName\n          );\n        }\n        return user;\n      })\n      .catch((err) => {\n        logger.debug('signIn error', err);\n        throw err;\n      });\n  };\n}\n\nfunction decorateSignOut(authState: Subject<AuthState>, Auth) {\n  const _signOut = Auth.signOut;\n  Auth.signOut = (opts: { global: boolean } | undefined): Promise<any> => {\n    return _signOut\n      .call(Auth, opts)\n      .then((data) => {\n        logger.debug('signOut success');\n        authState.next({ state: 'signedOut', user: null });\n        return data;\n      })\n      .catch((err) => {\n        logger.debug('signOut error', err);\n        throw err;\n      });\n  };\n}\n\nfunction decorateSignUp(authState: Subject<AuthState>, Auth) {\n  const _signUp = Auth.signUp;\n  Auth.signUp = (\n    username: string,\n    password: string,\n    email: string,\n    phone_number: string\n  ): Promise<any> => {\n    return _signUp\n      .call(Auth, username, password, email, phone_number)\n      .then((data) => {\n        logger.debug('signUp success');\n        authState.next({ state: 'confirmSignUp', user: { username } });\n        return data;\n      })\n      .catch((err) => {\n        logger.debug('signUp error', err);\n        throw err;\n      });\n  };\n}\n\nfunction decorateConfirmSignUp(authState: Subject<AuthState>, Auth) {\n  const _confirmSignUp = Auth.confirmSignUp;\n  Auth.confirmSignUp = (username: string, code: string): Promise<any> => {\n    return _confirmSignUp\n      .call(Auth, username, code)\n      .then((data) => {\n        logger.debug('confirmSignUp success');\n        authState.next({ state: 'signIn', user: { username } });\n        return data;\n      })\n      .catch((err) => {\n        logger.debug('confirmSignUp error', err);\n        throw err;\n      });\n  };\n}\n\nexport function authDecorator(authState: Subject<AuthState>, authModule) {\n  check(authState, authModule);\n  listen(authState);\n  decorateSignIn(authState, authModule);\n  decorateSignOut(authState, authModule);\n  decorateSignUp(authState, authModule);\n  decorateConfirmSignUp(authState, authModule);\n}\n"]}