# Description: this workflow runs build mega-apps that have all the connected components.

name: Mega App Canary

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

on:
  push:
    branches:
      - 'mega-app-canary'

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ci
    strategy:
      fail-fast: false
      matrix:
        # Paths for each example app we want to test build on
        include:
          - framework: react
            framework-version: 18
            build-tool: cra
            build-tool-version: 5
            pkg-manager: npm
            language: ts
    steps:
      - name: Checkout Amplify UI
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Setup Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn' # TODO: dynamic this
        env:
          SEGMENT_DOWNLOAD_TIMEOUT_MINS: 2
      - name: Install build-system-tests package
        uses: ./.github/actions/install-with-retries
        with:
          working-directory: ./build-system-tests
      - name: Add Amplify CLI
        run: yarn global add @aws-amplify/cli
      - name: Get CLI versions
        id: cli-version
        run: echo "version=$(amplify --version)" >> $GITHUB_OUTPUT
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: us-east-2
          role-to-assume: ${{ secrets.AUTH_E2E_ROLE_ARN }}
      # Amplify CLI does not support headless pull with temporary credentials
      # when useProfile is false.
      # See: https://github.com/aws-amplify/amplify-cli/issues/11009.
      - name: Create temp AWS profile
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID && \
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY && \
          aws configure set aws_session_token $AWS_SESSION_TOKEN && \
          aws configure set default.region $AWS_REGION
      - name: Pull down AWS environments
        run: yarn pull
        working-directory: ./build-system-tests/
      - name: Delete AWS Profile
        run: rm -rf ~/.aws
      - name: Create MegaApp ${{ matrix.framework }}-${{ matrix.framework-version }}-${{ matrix.build-tool }}-${{ matrix.build-tool-version }}-${{ matrix.language }}
        run: node --require esbuild-register ./scripts/create-react-app.ts
        working-directory: ./build-system-tests
      - name: Build MegaApp ${{ matrix.framework }}-${{ matrix.framework-version }}-${{ matrix.build-tool }}-${{ matrix.build-tool-version }}-${{ matrix.language }}
        run: yarn --cwd mega-apps/react-18-cra-5-ts build
        working-directory: ./build-system-tests
